# Примерный протокол обмена сообщениями #

По возможности следует использовать протокол UDP. Для удобства работы предусмотрена "библиотека" `dconnect.h`.

Более подробное описание всех функций и структур есть в заголовочном файле.




## Структура пакетов ##

Для удобства в библиотеке имеются следующие типы:

* `HR_ADDRESS`. Содержит IP-адрес и порт в читаемом виде

* `UPACK_HEAD`. "Заголовок" любого пересылаемого пакета. Все пересылаемые данные (которые передаются в поле `data`) должны удовлетворять этому заголовку (то есть указатель на эти данные можно корректно привести к типу `UPACK_HEAD*`)

У всех пакетов есть *type*, *stamp* и *data* (так же называются поля структуры `UPACK_HEAD`)

У функций для отправки пакетов есть параметр *repeats* &mdash; число повторных отправок за один вызов этой функции. Лучше использовать стандартные константы (есть в заголовочном файле).




## Соединение ##

#### `d_client_connect()` ####

Связывает клиент и сервер, обновляя данные друг о друге на каждой стороне.

1. Клиент посылает пакет с type = `DP_CONNECT` и stamp = `DP_S_ASK`. Отправка происходит до получения ответа от сервера, но не более чем столько раз, сколько определено в одной из локальных констант функции `d_client_connect()`
2. Если сервер разрешает клиенту присоединиться, он отправляет в ответ такой же пакет, но с stamp = `DP_S_SUCCESS`; repeats = `1`
3. Если сервер не разрешает клиенту присоединиться, он отправляет в ответ такой же пакет, но с stamp = `DP_S_ERROR`; repeats = `1`




## Обновление игрового поля ##

#### `d_server_send()` ####

Передаёт подготовленные данные об игровой ситуации клиенту.

1. Сервер посылает пакет с type = `DP_GAME` и stamp = текущий tick; repeats = `NET_REPEAT_SERVER`
2. Клиент никак не отвечает на этот пакет




## Передача команд от игрока ##

#### `d_client_send()` ####

Передаёт запрашиваемые игроком команды серверу.

1. Клиент посылает пакет с type = `DP_CLIENT_ACTION` и stamp = последний принятый от сервера tick; repeats = `NET_REPEAT_CLIENT`
2. Сервер никак не отвечает на этот пакет

Сервер должен для каждого клиента учитывать абсолютное время последнего принятого пакета. Если с того момента прошло больше некоторого time limit, то сервер должен выполнить следующее:

	* Если игра не идёт (возможно подключение новых клиентов), все данные о клиенте можно удалить
	* Если игра идёт (клиенту может потребоваться переподключение), следует как-либо отметить превышение time limit и **не отправлять** клиенту никаких пакетов до его переподключения

Клиент должен учитывать те же данные. В случае превышения time limit нужно автоматически переподключиться к серверу (см. далее)




## Переподключение клиента ##

#### `d_client_connect()` ####

Переподключает клиента к серверу. Процедура почти полностью повторяет обычное подключение.

1. Клиент посылает пакет с type = `DP_RECONNECT` и stamp = `DP_S_ASK`. Отправка происходит до получения ответа от сервера, но не более чем столько раз, сколько определено в одной из локальных констант функции `d_client_connect()`
2. Если сервер разрешает клиенту присоединиться, он отправляет в ответ такой же пакет, но с stamp = `DP_S_SUCCESS`; repeats = `1`
3. Если сервер не разрешает клиенту присоединиться, он отправляет в ответ такой же пакет, но с stamp = `DP_S_ERROR`; repeats = `1`




## Передача другой информации ##

#### `d_client_send()`, `d_server_send()` ####

Поскольку эти функции отправляют "сырые" данные, можно отправить любой пакет с соответствующим type. Если требуется новый тип пакета, следует внести его заголовок в

tick любого пакета на стороне клиента может быть проверен функцией `d_client_get()`. Поскольку серверу такая проверка обычно не требуется, в случае необходимости проверку нужно делать вручную.
